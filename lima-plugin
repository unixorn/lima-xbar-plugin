#!/usr/bin/env python3
#
# Lima Swiftbar/Xbar plugin
#
# Copyright 2021, Joe Block <jpb@unixorn.net>
#
# <xbar.title>Lima Control</xbar.title>
# <xbar.version>v1.0</xbar.version>
# <xbar.author>Joe Block</xbar.author>
# <xbar.author.github>unixorn</xbar.author.github>
# <xbar.desc>Control Lima VM</xbar.desc>
# <xbar.dependencies>jq,lima</xbar.dependencies>
# <xbar.image>https://raw.githubusercontent.com/unixorn/lima-xbar-plugin/main/pix/limactl-screen-shot.png</xbar.image>
# <xbar.abouturl>https://github.com/unixorn/lima-xbar-plugin/</xbar.abouturl>
# <swiftbar.runInBash>false</swiftbar.runInBash>
#
# Dependencies:
#   lima - https://github.com/lima-vm/lima
#   jq - https://stedolan.github.io/jq/

import argparse
import json
import logging
import logging.handlers
import os
import subprocess
import sys

# import syslog

# Running VM color (default green)
RUNNING_VM_COLOR = "#29cc00"

# Stopped VM color (default red)
STOPPED_VM_COLOR = "#ff0033"

VERSION = "1.1.1"


def logSetup(level: str = "INFO"):
    maclog = logging.handlers.SysLogHandler(
        address="/var/run/syslog", facility="local1"
    )
    maclog.ident = "lima-xbar"

    loglevel = getattr(logging, level.upper(), None)
    logFormat = " [%(asctime)s][%(levelname)8s][%(filename)s:%(lineno)s - %(funcName)20s() ] %(message)s"
    logging.basicConfig(level=loglevel, format=logFormat)

    maclog.setLevel(loglevel)

    # set a format which is simpler for console use
    formatter = logging.Formatter(" %(name)-12s: %(levelname)-8s %(message)s")

    # tell the handler to use this format
    maclog.setFormatter(formatter)

    # add the handler to the root logger
    logging.getLogger("").addHandler(maclog)
    logging.debug("Set log level to %s", level.upper())


def parseCLI():
    """
    Parse the command line options
    """
    parser = argparse.ArgumentParser(description="Lima Swiftbar/Xbar plugin")
    parser.add_argument("-d", "--debug", help="Debug setting", action="store_true")
    parser.add_argument(
        "-l",
        "--log-level",
        type=str.upper,
        help="set log level",
        choices=["DEBUG", "INFO", "ERROR", "WARNING", "CRITICAL"],
        default="INFO",
    )
    parser.add_argument(
        "--vm", "--virtual-machine", type=str, help="Which vm to use", default="default"
    )
    parser.add_argument("--target", type=str, help="Which image/vm/container to target")

    parser.add_argument(
        "--container-action",
        choices=["start", "stop", "rm", "pause", "unpause"],
        help="Action to perform on a container",
    )
    parser.add_argument(
        "--image-action", choices=["pull", "rm"], help="Action to perform on image"
    )
    parser.add_argument(
        "--vm-action",
        choices=["start", "stop"],
        help="Action to perform on vm",
    )
    cliArgs = parser.parse_args()
    return cliArgs


def runCommand(command: list, env=dict(os.environ)):
    """
    Run a command and decode the json output

    :param list command:
    :return dict:
    """
    return subprocess.run(command, env=env, stdout=subprocess.PIPE).stdout.decode(
        "utf-8"
    )


def jsonCommand(command: list, env=dict(os.environ)):
    """
    Run a command and decode the json output

    :param list command:
    :return dict:
    """
    json_output = runCommand(command=command, env=env)

    data = []
    for line in json_output.splitlines():
        try:
            details = json.loads(line)
            data.append(details)
        except json.decoder.JSONDecodeError:
            logging.error("Bad JSON returned: %s", line)
    return data


def listContainers(vm: str = "default"):
    """
    List all containers in a VM

    :param vm:

    :return dict:
    """
    containers = {}
    if vm != "default":
        env = dict(os.environ, LIMA_INSTANCE=vm)
    else:
        env = dict(os.environ)
    newpath = "%s:/usr/local/bin" % env["PATH"]
    env["PATH"] = newpath

    command = [
        "lima",
        "nerdctl",
        "container",
        "ls",
        "-a",
        "--format",
        "{{json .}}",
    ]
    raw = jsonCommand(command=command, env=env)
    for container in raw:
        try:
            if container["Names"] != "":
                key = container["Names"]
            else:
                key = container["ID"]
            containers[key] = container
        except KeyError:
            logging.error("Bad container record: %s", container)
    return containers


def listImages(vm: str = "default"):
    """
    List all images in a VM

    :param vm:

    :return dict:
    """
    images = {}
    if vm != "default":
        env = dict(os.environ, LIMA_INSTANCE=vm)
    else:
        env = dict(os.environ)

    newpath = "%s:/usr/local/bin" % env["PATH"]
    env["PATH"] = newpath

    command = ["lima", "nerdctl", "images", "--format", "{{json .}}"]
    raw = jsonCommand(command=command, env=env)
    logging.debug("Processing command output...")
    for image in raw:
        try:
            repo = "ERROR"
            tag = "ERROR"
            if "Repository" in image:
                repo = image["Repository"]
            else:
                logging.error("Repository key missing")
            if "Tag" in image:
                tag = image["Tag"]
            else:
                logging.error("Tag key missing")
            images["%s:%s" % (repo, tag)] = image
        except KeyError:
            logging.error("Bad image record: %s", image)
            logging.error("Keys: %s", image.keys())
            logging.error(" ")
    return images


def listVMs():
    """
    List all VMs

    :return dict:
    """
    vmList = {}

    env = dict(os.environ)
    newpath = "%s:/usr/local/bin" % env["PATH"]
    env["PATH"] = newpath

    vmRaw = subprocess.run(
        ["/usr/local/bin/limactl", "list", "--json"], env=env, stdout=subprocess.PIPE
    ).stdout.decode("utf-8")

    for vm in vmRaw.splitlines():
        details = json.loads(vm)
        vmList[details["name"]] = details
    return vmList


# Submenu processing


def prep_environment_for_lima(vm: str = "default", env: dict = dict(os.environ)):
    """
    Set up an environment dictionary we can use to run a lima command.

    Also adds /usr/local/bin to $PATH

    :param str vm: VM to work in
    """
    newpath = "%s:/usr/local/bin" % env["PATH"]
    env["PATH"] = newpath

    if vm != "default":
        env["LIMA_INSTANCE"] = vm
    return env


def containerOps(action: str, container: str, vm: str = "default"):
    """
    Handle container operations
    """
    logging.warning("containerOps")
    logging.debug("action: %s" % action)
    logging.debug("container: %s" % container)
    logging.debug("vm: %s" % vm)

    env = prep_environment_for_lima(vm=vm)

    command = ["lima", "nerdctl", "container", action, container]
    logging.warning("containerops command: %s", command)

    output = runCommand(command=command, env=env)
    logging.warning(output)
    logging.warning("%s complete", action)


def imageOps(action: str, image: str, vm: str = "default"):
    """
    Handle VM operations
    """
    logging.critical("imageOps")
    logging.info("action: %s" % action)
    logging.info("image: %s" % image)
    logging.info("vm: %s" % vm)

    env = prep_environment_for_lima(vm=vm)

    command = ["lima", "nerdctl", "image", action, image]
    logging.warning("command: %s", command)
    logging.warning("PATH: %s", env["PATH"])
    output = runCommand(command=command, env=env)
    logging.debug(output)
    logging.warning("%s complete", action)


def vmOps(action: str, vm: str = "default"):
    """
    Handle VM operations
    """
    logging.critical("vmOps")
    logging.debug("action: %s" % action)
    logging.debug("vm: %s" % vm)

    env = prep_environment_for_lima(vm=vm)

    command = ["limactl", action, vm]
    logging.warning("command: %s", command)
    output = runCommand(command=command, env=env)
    logging.debug(output)
    logging.warning("%s complete", action)


# Actual Xbar-compatible output


def xbar_icon(vms: dict = {}):
    """
    Determine icon to display in menubar
    """
    menuBarIcon = f"üêã ‚õî | color={STOPPED_VM_COLOR}"
    for vm in vms:
        logging.debug("vm: %s", vm)
        if vms[vm]["status"] == "Running":
            menuBarIcon = f"üêã üèÉ | color={RUNNING_VM_COLOR}"
            break
    print(menuBarIcon)
    print("---")


def aboutMenu():
    """
    Print details about plugin
    """
    limaVersion = subprocess.run(
        ["/usr/local/bin/limactl", "--version"], stdout=subprocess.PIPE
    ).stdout.decode("utf-8")

    print("About‚Ä¶")
    print("-- Lima version: %s" % limaVersion.strip())
    print("-- lima-xbar version: %s" % VERSION)
    print("-- force rescan | bash=limactl param1=list terminal=false refresh=true")


def vmContainerSubMenu(vm: str = "default"):
    """
    Generate a container submenu for a VM

    :param str vm:
    """
    # plugin_f = __file__.replace(" ", "\ ")
    plugin_f = __file__
    containers = listContainers(vm=vm)

    logging.debug("containers: %s", containers)

    print("-- Containers")
    for container in containers:
        if containers[container]["Status"] == "Up":
            print("---- %s | color=%s" % (container, RUNNING_VM_COLOR))
            print("------ Running")
            print(
                f'------ stop | shell="{plugin_f}" param1="--vm" param2={vm} param3="--container-action" param4=stop param5="--target" param6={container} terminal=false refresh=true'
            )
            print(
                f'------ kill | shell="{plugin_f}" param1="--vm" param2={vm} param3="--container-action" param4=kill param5="--target" param6={container} terminal=false refresh=true'
            )
            print(
                f'------ pause | shell="{plugin_f}" param1="--vm" param2={vm} param3="--container-action" param4=pause param5="--target" param6={container} terminal=false refresh=true'
            )
        else:
            print("---- %s | color=%s" % (container, STOPPED_VM_COLOR))
            print("------ Stopped")
            print(
                f'------ rm | shell="{plugin_f}" param1="--vm" param2={vm} param3="--container-action" param4=rm param5="--target" param6={container} terminal=false refresh=true'
            )
            print(
                f'------ start | shell="{plugin_f}" param1="--vm" param2={vm} param3="--container-action" param4=start param5="--target" param6={container} terminal=false refresh=true'
            )
            print(
                f'------ unpause | shell="{plugin_f}" param1="--vm" param2={vm} param3="--container-action" param4=unpause param5="--target" param6={container} terminal=false refresh=true'
            )


def vmImageSubMenu(vm: str = "default"):
    """
    Generate an image submenu for a VM

    :param str vm:
    """
    plugin_f = __file__
    images = listImages(vm=vm)

    logging.debug("images: %s", images)

    print("-- Images")
    for image in images:
        print("---- %s" % image)
        print(
            f'------ pull | bash="{plugin_f}" param1=--vm param2={vm} param3=--image-action=pull param4=--target={image} terminal=false refresh=true'
        )
        print(
            f'------ rm | bash="{plugin_f}" param1=--vm param2={vm} param3=--image-action=rm param4=--target={image} terminal=false refresh=true'
        )


def vmMenu(vmData: dict = {}):
    """
    Generate submenus for all the VMs, running or not
    """
    plugin_f = __file__
    logging.debug("vmMenu")
    logging.debug("vmData: %s", vmData)

    for vm in vmData:

        logging.debug("status %s", vmData[vm]["status"])
        if vmData[vm]["status"] != "Running":
            print("%s VM is stopped | color=%s" % (vm, STOPPED_VM_COLOR))
            print(
                f"""-- ‚õî Start {vm} VM | shell=\"{plugin_f}\" param1='--vm=default' param2='--vm-action=start' terminal=false refresh=true"""
            )
        else:
            print(f"{vm} VM (running) | color={RUNNING_VM_COLOR}")
            print(
                f"""-- ‚õî Stop {vm} VM | color={STOPPED_VM_COLOR} bash="{__file__}" shell=\"{plugin_f}\" param1='--vm=default' param2='--vm-action=stop' terminal=false refresh=true"""
            )
            vmContainerSubMenu(vm=vm)
            vmImageSubMenu(vm=vm)


def xbarMenu():
    """
    Generate Xbar Menu
    """
    vms = listVMs()

    xbar_icon(vms)
    aboutMenu()
    vmMenu(vmData=vms)


def main():
    """
    Main program driver
    """
    logSetup(level="DEBUG")

    logging.debug("plugin path: %s" % __file__)

    cli = parseCLI()
    logging.warning("VERSON: %s", VERSION)

    logging.debug("cli: %s" % cli)

    logging.warning("argv[0] %s" % sys.argv[0])

    if cli.container_action:
        logging.info("container action: %s", cli.container_action)
        containerOps(vm=cli.vm, action=cli.container_action, container=cli.target)

    if cli.image_action:
        logging.info("image action: %s", cli.image_action)
        imageOps(action=cli.image_action, image=cli.target, vm=cli.vm)

    if cli.vm_action:
        logging.info("vm action: %s", cli.vm_action)
        vmOps(action=cli.vm_action, vm=cli.vm)

    xbarMenu()


if __name__ == "__main__":
    main()
